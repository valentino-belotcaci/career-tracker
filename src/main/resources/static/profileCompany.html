<script>
(function () {
  // ===== AUTH BOOTSTRAP =====
  const token = localStorage.getItem('jwt');
  const loggedId = localStorage.getItem('loggenId'); // canonical key set by login

  if (!token) {
    console.warn('Missing JWT, redirecting to login');
    window.location.href = '/login.html';
    return;
  }

  // Global helper for authenticated requests
  window.authFetch = function (url, opts = {}) {
    opts = opts || {};
    opts.headers = opts.headers || {};
    opts.headers = Object.assign({}, opts.headers, {
      'Authorization': 'Bearer ' + token
    });
    return fetch(url, opts);
  };

  // ===== LOAD COMPANY =====
  async function loadCompany() {
    const note = document.getElementById('note');

    if (!loggedId) {
      note.textContent = 'No logged account found. Please log in.';
      return;
    }

    try {
      const res = await authFetch(`/Company/getCompanyByAccountId/${encodeURIComponent(loggedId)}`);

      if (res.status === 404) {
        note.textContent = 'No company profile found for this account.';
        return;
      }
      if (!res.ok) throw new Error('Failed to load company');

      const company = await res.json();
      const companyId = company.id || company.companyId || '';

      document.getElementById('companyId').value = companyId;

      document.getElementById('name').value = company.name || '';
      document.getElementById('email').value = company.email || '';
      document.getElementById('description').value = company.description || '';

      document.getElementById('viewName').textContent = company.name || '';
      document.getElementById('viewEmail').textContent = company.email || '';
      document.getElementById('viewDescription').textContent = company.description || '';

      note.style.display = 'none';
      document.getElementById('viewMode').style.display = 'block';
    } catch (err) {
      console.error(err);
      note.textContent = 'Error loading company profile.';
    }
  }

  // ===== UI TOGGLES =====
  document.getElementById('editBtn').addEventListener('click', () => {
    document.getElementById('viewMode').style.display = 'none';
    document.getElementById('editMode').style.display = 'block';
  });

  document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('editMode').style.display = 'none';
    document.getElementById('viewMode').style.display = 'block';
  });

  // ===== SAVE COMPANY =====
  document.getElementById('editMode').addEventListener('submit', async function (e) {
    e.preventDefault();

    const payload = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      description: document.getElementById('description').value
    };

    const msg = document.getElementById('message');
    const saveBtn = e.target.querySelector('button[type="submit"]');
    saveBtn.disabled = true;

    try {
      let companyId = document.getElementById('companyId').value;

      if (!companyId) {
        const res = await authFetch(
          `/Company/getCompanyByAccountId/${encodeURIComponent(loggedId)}`
        );
        if (!res.ok) throw new Error('Unable to resolve company ID');
        const company = await res.json();
        companyId = company.id || company.companyId || '';
        document.getElementById('companyId').value = companyId;
      }

      const updateRes = await authFetch(
        `/Company/updateCompany/${encodeURIComponent(companyId)}`,
        {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }
      );

      if (!updateRes.ok) {
        const text = await updateRes.text();
        throw new Error(text || 'Update failed');
      }

      document.getElementById('viewName').textContent = payload.name;
      document.getElementById('viewEmail').textContent = payload.email;
      document.getElementById('viewDescription').textContent = payload.description;

      msg.style.color = 'green';
      msg.textContent = 'Saved successfully.';
      document.getElementById('editMode').style.display = 'none';
      document.getElementById('viewMode').style.display = 'block';
    } catch (err) {
      console.error(err);
      msg.style.color = 'red';
      msg.textContent = err.message || 'Error saving changes';
    } finally {
      saveBtn.disabled = false;
    }
  });

  loadCompany();
})();
</script>
