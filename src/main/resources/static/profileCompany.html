<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Company Profile - CareerTracker</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <header>
      <a class="site-title" href="/indexCompany.html">CareerTracker</a>
    </header>

    <main class="wide-card">
      <h2>Company Profile</h2>

      <p id="note">Loading your company profile…</p>

      <div id="viewMode" style="display:none;">
        <p><strong>Company name:</strong> <span id="viewName"></span></p>
  <p><strong>Email:</strong> <span id="viewEmail"></span></p>
        <p><strong>Description:</strong> <span id="viewDescription"></span></p>
        <div>
          <button id="editBtn">Edit</button>
        </div>
      </div>

      <form id="editMode" style="display:none;">
        <input type="hidden" id="companyId">

  <label for="name">Company name</label>
  <input id="name" type="text">

  <label for="email">Email</label>
  <input id="email" type="email">

  <label for="description">Description</label>
  <input id="description" type="text">

        <div style="display:flex; gap:0.5rem; margin-top:1rem;">
          <button type="submit">Save</button>
          <button type="button" id="cancelBtn">Cancel</button>
        </div>
      </form>

      <p id="message"></p>
    </main>

    <footer>
      <p>© 2026 CareerTracker</p>
    </footer>

    <script>
      // Load company profile for the logged account
      async function loadCompany() {
        const loggedAccountId = localStorage.getItem('loggedAccountId');
        const note = document.getElementById('note');
        if (!loggedAccountId) {
          note.textContent = 'No logged account found. Please log in.';
          return;
        }

        try {
          const res = await fetch(`/Company/getCompanyByAccountId/${encodeURIComponent(loggedAccountId)}`);
          if (res.status === 404) {
            note.textContent = 'No company profile found for this account.';
            return;
          }
          if (!res.ok) throw new Error('Failed to load company');

          const company = await res.json();

          // backend uses companyId as the primary key
          document.getElementById('companyId').value = company.companyId || '';
          document.getElementById('name').value = company.name || '';
          document.getElementById('email').value = company.email || '';
          document.getElementById('description').value = company.description || '';

          document.getElementById('viewName').textContent = company.name || '';
          document.getElementById('viewEmail').textContent = company.email || '';
          document.getElementById('viewDescription').textContent = company.description || '';

          note.style.display = 'none';
          document.getElementById('viewMode').style.display = 'block';
        } catch (err) {
          console.error(err);
          note.textContent = 'Error loading company profile.';
        }
      }

      // Toggle to edit mode
      document.getElementById('editBtn').addEventListener('click', function(){
        document.getElementById('viewMode').style.display = 'none';
        document.getElementById('editMode').style.display = 'block';
      });

      // Cancel edit
      document.getElementById('cancelBtn').addEventListener('click', function(){
        document.getElementById('editMode').style.display = 'none';
        document.getElementById('viewMode').style.display = 'block';
      });

      // Submit save handler: ensure we have the company id, fetching it by account id when missing
      document.getElementById('editMode').addEventListener('submit', async function(e){
        e.preventDefault();

        const payload = {
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          description: document.getElementById('description').value
        };
        const msg = document.getElementById('message');
        const saveBtn = e.target.querySelector('button[type="submit"]');
        saveBtn.disabled = true;

        try {
          // Try to get id from hidden input
          let id = document.getElementById('companyId').value;

          // If missing, fetch company by account id to obtain it
          if (!id) {
            const loggedAccountId = localStorage.getItem('loggedAccountId');
            if (!loggedAccountId) {
              msg.style.color = 'red';
              msg.textContent = 'No logged account found. Please log in.';
              saveBtn.disabled = false;
              return;
            }

            const res = await fetch(`/Company/getCompanyByAccountId/${encodeURIComponent(loggedAccountId)}`);
            if (res.status === 404) {
              msg.style.color = 'red';
              msg.textContent = 'No company profile found for this account.';
              saveBtn.disabled = false;
              return;
            }
            if (!res.ok) {
              throw new Error('Failed to fetch company id');
            }

            const company = await res.json();
            id = company.companyId;
            // persist the id in the hidden input for subsequent saves
            document.getElementById('companyId').value = id || '';
          }

          // Perform update
          const updateRes = await fetch(`/Company/updateCompany/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });

          if (!updateRes.ok) {
            // parse body for details
            let bodyText = '';
            try { bodyText = JSON.stringify(await updateRes.json()); } catch(_) {
              try { bodyText = await updateRes.text(); } catch(_) { bodyText = '<no body>'; }
            }
            console.error('Update company failed', updateRes.status, bodyText);
            msg.style.color = 'red';
            msg.textContent = `Failed to save changes (${updateRes.status}): ${bodyText}`;
            saveBtn.disabled = false;
            return;
          }

          // update view
          document.getElementById('viewName').textContent = payload.name || '';
          document.getElementById('viewEmail').textContent = payload.email || '';
          document.getElementById('viewDescription').textContent = payload.description || '';

          msg.style.color = 'green';
          msg.textContent = 'Saved successfully.';
          document.getElementById('editMode').style.display = 'none';
          document.getElementById('viewMode').style.display = 'block';
          saveBtn.disabled = false;
        } catch (err) {
          console.error('Error saving company', err);
          msg.style.color = 'red';
          msg.textContent = `Error saving changes: ${err && err.message ? err.message : err}`;
          saveBtn.disabled = false;
        }
      });

      loadCompany();
    </script>
  </body>
</html>
