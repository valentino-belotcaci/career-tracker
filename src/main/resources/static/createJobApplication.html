<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create Job Application - CareerTracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header>
  <a id="homeLink" class="site-title" href="#">CareerTracker</a>
</header>

<main class="wide-card">
  <h2>Create Job Application</h2>
  <p id="note">Fill in the information for your application below.</p>

  <form id="applicationForm" class="edit-only">
    <!-- hidden fields for backend -->
    <input type="hidden" id="postId" name="postId">
    <input type="hidden" id="userId" name="userId">

    <!-- editable fields for application info -->
    <label for="status">Status</label>
    <input type="text" id="status" name="status" placeholder="e.g., Pending" required>

    <label for="coverLetter">Cover Letter</label>
    <textarea id="coverLetter" name="coverLetter" placeholder="Write your cover letter here..." rows="5"></textarea>

    <div class="button-row">
      <button type="submit" class="btn">Submit</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
    </div>
  </form>

  <p id="message"></p>
</main>

<footer>
  <p>Â© 2026 CareerTracker</p>
</footer>

<script>
(function () {
  // ===== HOME LINK =====
  const type = localStorage.getItem("type");
  const homeLink = document.getElementById("homeLink");
  if (type === "USER") homeLink.href = "/indexUser.html";
  else if (type === "COMPANY") homeLink.href = "/indexCompany.html";
  else homeLink.href = "/index.html";

  // ===== HELPERS =====
  function getQueryParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  function authFetch(url, opts = {}) {
    const token = localStorage.getItem("jwt");
    if (!token) throw new Error("Not authenticated");
    opts.headers = { ...(opts.headers || {}), Authorization: "Bearer " + token };
    return fetch(url, opts);
  }

  // ===== INITIALIZE =====
  const form = document.getElementById("applicationForm");
  const message = document.getElementById("message");
  const cancelBtn = document.getElementById("cancelBtn");

  // Get postId from query param
  const postId = getQueryParam("postId");
  const userId = localStorage.getItem("loggedId");

  if (!postId || !userId) {
    message.style.color = "red";
    message.textContent = "Cannot create application: missing post or user ID.";
    form.querySelector("button[type='submit']").disabled = true;
    return;
  }

  // Set hidden inputs
  document.getElementById("postId").value = postId;
  document.getElementById("userId").value = userId;

  // ===== CANCEL BUTTON =====
  cancelBtn.addEventListener("click", () => {
    window.history.back();
  });

  // ===== FORM SUBMISSION =====
  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    message.textContent = "";
    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;

    try {
      const payload = {
        postId: Number(postId),
        userId: Number(userId),
        status: document.getElementById("status").value,
        // Include additional fields if needed
      };

      const res = await authFetch("/JobApplication/insert", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Failed to create application");

      const created = await res.json();
      message.style.color = "green";
      message.textContent = `Application submitted! (ID: ${created.applicationId || created.id})`;

      // disable form to avoid double submission
      submitBtn.disabled = true;
      form.querySelectorAll("input, textarea").forEach(el => el.disabled = true);

    } catch (err) {
      console.error(err);
      message.style.color = "red";
      message.textContent = err.message || "Error submitting application.";
      submitBtn.disabled = false;
    }
  });

})();
</script>
</body>
</html>
