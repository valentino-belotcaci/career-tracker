<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Profile - CareerTracker</title>
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <header>
      <a class="site-title" href="/indexUser.html">CareerTracker</a>
    </header>

    <main class="wide-card">
      <h2>User Profile</h2>

      <p id="note">Loading your profile…</p>

      <div id="viewMode" class="view-only hidden">
        <p><strong>First name:</strong> <span id="viewFirstName"></span></p>
        <p><strong>Last name:</strong> <span id="viewLastName"></span></p>
        <p><strong>Email:</strong> <span id="viewEmail"></span></p>
        <p><strong>Description:</strong> <span id="viewDescription"></span></p>
        <div class="spaced">
          <button id="editBtn" class="btn">Edit</button>
        </div>
      </div>

      <form id="editMode" class="edit-only hidden">
        <input type="hidden" id="userId">

        <label for="firstName">First name</label>
        <input id="firstName" type="text">

        <label for="lastName">Last name</label>
        <input id="lastName" type="text">

        <label for="email">Email</label>
        <input id="email" type="email">

        <label for="description">Description</label>
        <input id="description" type="text">

        <div class="button-row">
          <button type="submit" class="btn">Save</button>
          <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>

      <p id="message"></p>
    </main>

    <footer>
      <p>© 2026 CareerTracker</p>
    </footer>

    <script>
(function () {
  // ===== AUTH BOOTSTRAP =====
  // With HttpOnly cookies, we do NOT read the JWT in JS anymore.
  // We rely on the server sending it as a cookie and fetch with credentials.
  const loggedId = localStorage.getItem('loggenId') || localStorage.getItem('loggedId');

  if (!loggedId) {
    console.warn('No logged account id found, redirecting to login');
    window.location.href = '/login.html';
    return;
  }

  // authFetch helper: automatically sends cookies
  window.authFetch = function (url, opts = {}) {
    opts = opts || {};
    opts.credentials = 'include'; // send cookies automatically
    opts.headers = opts.headers || {};
    return fetch(url, opts);
  };

  const note = document.getElementById('note');
  const viewMode = document.getElementById('viewMode');
  const editMode = document.getElementById('editMode');
  const message = document.getElementById('message');

  // ===== LOAD PROFILE =====
  async function loadProfile() {
    if (!loggedId) {
      note.textContent = 'No logged account id found. Please log in.';
      return;
    }

    try {
      const res = await authFetch(`/User/getUserByAccountId/${encodeURIComponent(loggedId)}`);
      if (res.status === 404) {
        note.textContent = 'No user profile found for this account.';
        return;
      }
      if (!res.ok) throw new Error('Failed to load user');

      const user = await res.json();

      // populate id and view spans (edit inputs are filled only on Edit)
      document.getElementById('userId').value = user.id || user.userId || '';
      const first = user.firstName || (user.name ? user.name.split(' ')[0] : '') || '';
      const last = user.lastName || (user.name ? user.name.split(' ').slice(1).join(' ') : '') || '';
      document.getElementById('viewFirstName').textContent = first;
      document.getElementById('viewLastName').textContent = last;
      document.getElementById('viewEmail').textContent = user.email || '';
      document.getElementById('viewDescription').textContent = user.description || '';

      // ensure only view mode visible initially
      document.body.classList.remove('editing');
      note.classList.add('hidden');
      viewMode.classList.remove('hidden');
      editMode.classList.add('hidden');
    } catch (err) {
      console.error(err);
      note.textContent = 'Error loading profile.';
    }
  }

  // ===== UI BINDINGS =====
  const editBtn = document.getElementById('editBtn');
  if (editBtn) {
    editBtn.addEventListener('click', () => {
      document.getElementById('firstName').value = document.getElementById('viewFirstName').textContent || '';
      document.getElementById('lastName').value = document.getElementById('viewLastName').textContent || '';
      document.getElementById('email').value = document.getElementById('viewEmail').textContent || '';
      document.getElementById('description').value = document.getElementById('viewDescription').textContent || '';

      document.body.classList.add('editing');
      viewMode.classList.add('hidden');
      editMode.classList.remove('hidden');
    });
  }

  const cancelBtn = document.getElementById('cancelBtn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      document.body.classList.remove('editing');
      editMode.classList.add('hidden');
      viewMode.classList.remove('hidden');
      message.textContent = '';
    });
  }

  if (editMode) {
    editMode.addEventListener('submit', async function (e) {
      e.preventDefault();
      message.textContent = '';
      const saveBtn = editMode.querySelector('button[type="submit"]');
      if (saveBtn) saveBtn.disabled = true;

      try {
        let id = document.getElementById('userId').value;
        if (!id) {
          const r = await authFetch(`/User/getUserByAccountId/${encodeURIComponent(loggedId)}`);
          if (r.status === 404) {
            message.style.color = 'red';
            message.textContent = 'No user profile found for this account.';
            if (saveBtn) saveBtn.disabled = false;
            return;
          }
          if (!r.ok) throw new Error('Failed to fetch user id');
          const u = await r.json();
          id = u.id || u.userId || '';
          document.getElementById('userId').value = id || '';
        }

        const payload = {
          firstName: document.getElementById('firstName').value,
          lastName: document.getElementById('lastName').value,
          email: document.getElementById('email').value,
          description: document.getElementById('description').value
        };

        const res = await authFetch(`/User/updateUser/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          let bodyText = '';
          try { bodyText = JSON.stringify(await res.json()); } catch (_) {
            try { bodyText = await res.text(); } catch (_) { bodyText = '<no body>'; }
          }
          throw new Error(bodyText || `Failed to save changes (${res.status})`);
        }

        // update view
        document.getElementById('viewFirstName').textContent = payload.firstName || '';
        document.getElementById('viewLastName').textContent = payload.lastName || '';
        document.getElementById('viewEmail').textContent = payload.email || '';
        document.getElementById('viewDescription').textContent = payload.description || '';

        message.style.color = 'green';
        message.textContent = 'Saved successfully.';
        document.body.classList.remove('editing');
        editMode.classList.add('hidden');
        viewMode.classList.remove('hidden');
      } catch (err) {
        console.error('Error saving user', err);
        message.style.color = 'red';
        message.textContent = err && err.message ? err.message : 'Error saving changes';
      } finally {
        if (saveBtn) saveBtn.disabled = false;
      }
    });
  }

  loadProfile();
})();
</script>
  </body>
</html>
