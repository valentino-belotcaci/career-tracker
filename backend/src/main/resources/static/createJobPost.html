<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create Job Post - CareerTracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <a class="site-title" href="/indexCompany.html">CareerTracker</a>
  </header>

  <main class="wide-card">
    <h2>Create Job Post</h2>
    <p id="note">Fill the form and click Create.</p>

    <form id="createForm">
      <input type="hidden" id="companyId" name="companyId" />

      <label for="name">Job title</label><br />
      <input id="name" name="name" type="text" required /><br />

      <label for="description">Description</label><br />
      <textarea id="description" name="description" rows="4" required></textarea><br />

      <label for="duration">Duration</label><br />
      <input id="duration" name="duration" type="text" /><br />

      <label for="available">Available</label><br />
      <input id="available" name="available" type="text" /><br />

      <label for="salary">Salary</label><br />
      <input id="salary" name="salary" type="number" /><br />

      <p id="message"></p>
      <button type="submit">Create</button>
      <a href="/displayJobPost.html"><button type="button">Cancel</button></a>
    </form>
  </main>

  <footer>
    <p>© 2026 CareerTracker</p>
  </footer>

  <script>
    // ===== Auth fetch helper =====
    // This automatically sends cookies including HttpOnly JWT
    async function authFetch(url, opts = {}) {
      opts = opts || {};
      opts.credentials = 'include'; // attach cookies automatically
      opts.headers = opts.headers || {};
      return fetch(url, opts);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const message = document.getElementById('message');
      const companyIdInput = document.getElementById('companyId');
      const form = document.getElementById('createForm');

      // ===== Get loggedId from localStorage (only for identifying account) =====
      const loggedId = localStorage.getItem('loggedId');
      if (!loggedId) {
        message.textContent = 'No logged account found. Please log in.';
        form.querySelector('button[type="submit"]').disabled = true;
        setTimeout(() => window.location.href = '/login.html', 1500);
        return;
      }

      try {
        // ===== Fetch company using account ID =====
        const res = await authFetch(`/Company/getCompanyByAccountId/${encodeURIComponent(loggedId)}`);

        if (res.status === 401 || res.status === 403) {
          message.textContent = 'You are not logged in. Redirecting to login…';
          setTimeout(() => window.location.href = '/login.html', 1500);
          return;
        }

        if (res.status === 404) {
          message.textContent = 'No company profile found for this account.';
          form.querySelector('button[type="submit"]').disabled = true;
          return;
        }

        const company = await res.json();
        const companyId = company.company_id || company.companyId || company.id;
        if (!companyId) throw new Error('Company ID not found');

        companyIdInput.value = Number(companyId);

        // ===== Submit form handler =====
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const payload = {
            companyId: Number(companyIdInput.value),
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            duration: document.getElementById('duration').value,
            available: document.getElementById('available').value,
            salary: Number(document.getElementById('salary').value) || 0
          };

          try {
            // POST request sends cookie automatically via authFetch
            const postRes = await authFetch('/JobPost/insertPost', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!postRes.ok) throw new Error('Failed to create job post');

            window.location.href = '/displayJobPost.html';
          } catch (err) {
            console.error(err);
            message.textContent = 'Failed to create job post. ' + err.message;
          }
        });

      } catch (err) {
        console.error(err);
        message.textContent = 'Error: ' + err.message;
        form.querySelector('button[type="submit"]').disabled = true;
      }
    });
  </script>
</body>
</html>
