<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>User Profile - CareerTracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header>
  <a id="homeLink" class="site-title" href="#">CareerTracker</a>
</header>

<main class="wide-card">
  <h2>User Profile</h2>

  <p id="note">Loading your profile…</p>

  <div id="viewMode" class="view-only hidden">
    <p><strong>First name:</strong> <span id="viewFirstName"></span></p>
    <p><strong>Last name:</strong> <span id="viewLastName"></span></p>
    <p><strong>Email:</strong> <span id="viewEmail"></span></p>
    <p><strong>Description:</strong> <span id="viewDescription"></span></p>
    <div class="spaced">
      <button id="editBtn" class="btn">Edit</button>
    </div>
  </div>

  <form id="editMode" class="edit-only hidden">
    <input type="hidden" id="userId">

    <label for="firstName">First name</label>
    <input id="firstName" type="text">

    <label for="lastName">Last name</label>
    <input id="lastName" type="text">

    <label for="email">Email</label>
    <input id="email" type="email">

    <label for="description">Description</label>
    <input id="description" type="text">

    <div class="button-row">
      <button type="submit" class="btn">Save</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
    </div>
  </form>

  <p id="message"></p>
</main>

<footer>
  <p>© 2026 CareerTracker</p>
</footer>

<script>
(async function() {
  const loggedId = localStorage.getItem('loggedId');
  const accountType = localStorage.getItem('type');

  if (!loggedId || accountType !== 'USER') {
    alert('You must be logged in as a user to view this page.');
    window.location.href = '/login.html';
    return;
  }

  const note = document.getElementById('note');
  const viewMode = document.getElementById('viewMode');
  const editMode = document.getElementById('editMode');
  const message = document.getElementById('message');

  const homeLink = document.getElementById('homeLink');
  homeLink.href = '/indexUser.html';

  // Fetch helper
  async function authFetch(url, opts = {}) {
    opts.credentials = 'include';
    opts.headers = opts.headers || {};
    return fetch(url, opts);
  }

  async function loadProfile() {
    try {
      const res = await authFetch(`/Account/getAccountById/${encodeURIComponent(loggedId)}`);
      if (!res.ok) throw new Error(`Failed to load profile (${res.status})`);
      const user = await res.json();

      document.getElementById('userId').value = user.id || user.userId || '';
      const first = user.firstName || '---';
      const last = user.lastName || '---';
      const description = user.description || '---';
      document.getElementById('viewFirstName').textContent = first;
      document.getElementById('viewLastName').textContent = last;
      document.getElementById('viewEmail').textContent = user.email;
      document.getElementById('viewDescription').textContent = description;

      note.classList.add('hidden');
      viewMode.classList.remove('hidden');
    } catch (err) {
      console.error(err);
      note.textContent = 'Error loading profile.';
    }
  }

  // Edit button
  document.getElementById('editBtn').addEventListener('click', () => {
    document.getElementById('firstName').value = document.getElementById('viewFirstName').textContent;
    document.getElementById('lastName').value = document.getElementById('viewLastName').textContent;
    document.getElementById('email').value = document.getElementById('viewEmail').textContent;
    document.getElementById('description').value = document.getElementById('viewDescription').textContent;

    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
  });

  // Cancel button
  document.getElementById('cancelBtn').addEventListener('click', () => {
    editMode.classList.add('hidden');
    viewMode.classList.remove('hidden');
    message.textContent = '';
  });

  // Form submit
  editMode.addEventListener('submit', async e => {
    e.preventDefault();
    message.textContent = '';
    const saveBtn = editMode.querySelector('button[type="submit"]');
    saveBtn.disabled = true;

    try {
      const id = document.getElementById('userId').value;
      const payload = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        description: document.getElementById('description').value
      };

      const res = await authFetch(`/Account/updateAccount/${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error('Failed to save changes.');

      // Update view mode
      document.getElementById('viewFirstName').textContent = payload.firstName;
      document.getElementById('viewLastName').textContent = payload.lastName;
      document.getElementById('viewEmail').textContent = payload.email;
      document.getElementById('viewDescription').textContent = payload.description;

      message.style.color = 'green';
      message.textContent = 'Saved successfully.';
      editMode.classList.add('hidden');
      viewMode.classList.remove('hidden');
    } catch (err) {
      console.error(err);
      message.style.color = 'red';
      message.textContent = err.message || 'Error saving changes.';
    } finally {
      saveBtn.disabled = false;
    }
  });

  await loadProfile();
})();
</script>
</body>
</html>
