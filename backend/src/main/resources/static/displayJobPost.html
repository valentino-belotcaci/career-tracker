<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Company Job Posts - CareerTracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <!-- Dynamic home link -->
    <a id="homeLink" class="site-title" href="#">CareerTracker</a>
  </header>

  <main class="wide-card">
    <h2 id="pageTitle">Your Job Posts</h2>
    <div class="add-post-container">
      <a href="/createJobPost.html"><button id="addPostBtn">Add job post</button></a>
    </div>
    <p id="note">Loading…</p>

    <table id="postsTable" class="posts-table hidden">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Duration</th>
          <th>Available</th>
          <th>Salary</th>
        </tr>
      </thead>
      <tbody id="postsBody"></tbody>
    </table>

    <p id="message"></p>
  </main>

  <footer>
    <p>© 2026 CareerTracker</p>
  </footer>

  <script>
    // ===== authFetch using HttpOnly cookie =====
    function authFetch(url, opts = {}) {
      opts = opts || {};
      opts.credentials = 'include'; // send cookies automatically
      opts.headers = opts.headers || {};
      return fetch(url, opts);
    }

    // ===== Home link dynamically based on type =====
    const type = localStorage.getItem('type'); // account type still in localStorage
    const homeLink = document.getElementById('homeLink');
    if (homeLink) {
      if (type === 'USER') homeLink.href = '/indexUser.html';
      else if (type === 'COMPANY') homeLink.href = '/indexCompany.html';
      else homeLink.href = '/index.html';
    }

    // ===== Load posts =====
    async function loadPostsBasedOnType() {
      const note = document.getElementById('note');
      const tbody = document.getElementById('postsBody');
      const pageTitle = document.getElementById('pageTitle');
      const addBtn = document.getElementById('addPostBtn');
      const postsTable = document.getElementById('postsTable');

      if (type === "USER") {
        if (pageTitle) pageTitle.textContent = 'All Job Posts';
        if (addBtn && addBtn.parentElement) addBtn.parentElement.style.display = 'none';
      } else {
        if (pageTitle) pageTitle.textContent = 'Your Job Posts';
        if (addBtn && addBtn.parentElement) addBtn.parentElement.style.display = '';
      }

      try {
        let postsRes;

        if (type === "COMPANY") {
          const loggedAccountId = localStorage.getItem('loggedId');
          if (!loggedAccountId) {
            note.textContent = 'No logged account found. Please log in.';
            return;
          }

          // Get company by account id
          const companyRes = await authFetch(`/Account/getAccountById/${encodeURIComponent(loggedAccountId)}`);
          if (!companyRes.ok) {
            if (companyRes.status === 404) {
              note.textContent = 'No company profile found for this account.';
              return;
            }
            throw new Error('Failed to load company');
          }

          const company = await companyRes.json();
          if (!company) {
            note.textContent = 'No company profile found for this account.';
            return;
          }

          // Request posts for this company
          const companyId = company.id || company.companyId;
          postsRes = await authFetch(`/JobPost/getPostsByCompanyId/${encodeURIComponent(companyId)}`);
        } else {
          // USER: fetch all posts
          postsRes = await authFetch('/JobPost/getAllPosts');
        }

        if (!postsRes.ok) {
          if (postsRes.status === 404) {
            note.textContent = 'No job posts found.';
            return;
          }
          throw new Error('Failed to load posts');
        }

        const posts = await postsRes.json();
        if (!posts || posts.length === 0) {
          note.textContent = 'No job posts found.';
          return;
        }

        tbody.innerHTML = '';
        posts.forEach(p => {
          const tr = document.createElement('tr');
          const idVal = p.postId || p.id;
          tr.innerHTML = `
            <td>${idVal}</td>
            <td>${p.name || ''}</td>
            <td>${p.description || ''}</td>
            <td>${p.duration || ''}</td>
            <td>${p.available || ''}</td>
            <td>${p.salary || 'Not specified'}</td>
          `;
          tr.style.cursor = 'pointer';
          tr.addEventListener('click', () => {
            if (!idVal) return;
            window.location.href = `/jobPostDetails.html?postId=${encodeURIComponent(idVal)}`;
          });
          tbody.appendChild(tr);
        });

        note.classList.add('hidden');
        postsTable.classList.remove('hidden');
      } catch (err) {
        console.error(err);
        note.textContent = 'Error loading job posts.';
      }
    }

    // Initialize
    loadPostsBasedOnType();
    const pollInterval = setInterval(loadPostsBasedOnType, 2500);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') loadPostsBasedOnType();
    });
  </script>
</body>
</html>
