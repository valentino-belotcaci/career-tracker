<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create Job Application - CareerTracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header>
  <a id="homeLink" class="site-title" href="#">CareerTracker</a>
</header>

<main class="wide-card">
  <h2>Create Job Application</h2>
  <p id="note">Add your description for this job application.</p>

  <form id="applicationForm" class="edit-only">
    <!-- hidden fields for backend -->
    <input type="hidden" id="postId" name="postId">
    <input type="hidden" id="userId" name="userId">

    <label for="userDescription">Description</label>
    <textarea id="userDescription" name="userDescription" placeholder="Write your description..." rows="5" required></textarea>

    <div class="button-row">
      <button type="submit" class="btn">Submit</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
    </div>
  </form>

  <p id="message"></p>
</main>

<footer>
  <p>Â© 2026 CareerTracker</p>
</footer>

<script>
(async function () {
  // ===== HELPERS =====
  function getQueryParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  async function authFetch(url, opts = {}) {
    opts = opts || {};
    opts.credentials = 'include';
    opts.headers = opts.headers || {};
    return fetch(url, opts);
  }

  // ===== ELEMENTS =====
  const form = document.getElementById("applicationForm");
  const message = document.getElementById("message");
  const cancelBtn = document.getElementById("cancelBtn");
  const postId = getQueryParam("postId");

  cancelBtn.addEventListener("click", () => window.history.back());

  // ===== GET USER INFO FROM localStorage ONLY =====
  let userId = localStorage.getItem("loggedId");
  let accountType = localStorage.getItem("type");

  if (!userId || !accountType) {
    message.style.color = "red";
    message.textContent = "You must be logged in to create an application.";
    form.querySelector("button[type='submit']").disabled = true;
    return;
  }

  // ===== VALIDATE USER PROFILE BEFORE ALLOWING APPLICATION =====
  async function validateUserProfile(uid) {
    try {
      const res = await authFetch(`/Account/getAccountById/${encodeURIComponent(uid)}`);
      if (!res.ok) {
        message.style.color = "red";
        message.textContent = "No user profile found for this account.";
        form.querySelector("button[type='submit']").disabled = true;
        return false;
      }

      const user = await res.json();

      const requiredChecks = [
        { label: 'First name', keys: ['firstName', 'first_name', 'name'] },
        { label: 'Last name', keys: ['lastName', 'last_name', 'surname'] },
        { label: 'Password', keys: ['password'] },
        { label: 'Email', keys: ['email', 'contactEmail', 'contact_email'] },
        { label: 'Description', keys: ['description', 'bio', 'about'] }
      ];

      function hasAnyKey(obj, keys) {
        return keys.some(k => obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '');
      }

      const missing = requiredChecks.filter(rc => !hasAnyKey(user, rc.keys)).map(rc => rc.label);
      if (missing.length > 0) {
        message.style.color = "red";
        message.textContent = `Complete your user profile before applying. Missing: ${missing.join(', ')}.`;
        form.querySelector("button[type='submit']").disabled = true;
        return false;
      }

      return true;
    } catch (err) {
      console.error(err);
      message.style.color = "red";
      message.textContent = "Error loading user profile.";
      form.querySelector("button[type='submit']").disabled = true;
      return false;
    }
  }

  if (!(await validateUserProfile(userId))) return;

  // ===== INITIALIZE FORM =====
  if (!postId) {
    message.style.color = "red";
    message.textContent = "Missing post ID.";
    form.querySelector("button[type='submit']").disabled = true;
    return;
  }

  document.getElementById("postId").value = postId;
  document.getElementById("userId").value = userId;

  // ===== SET HOME LINK =====
  const homeLink = document.getElementById("homeLink");
  homeLink.href = accountType === "USER" ? "/indexUser.html"
                : accountType === "COMPANY" ? "/indexCompany.html"
                : "/index.html";

  // ===== FORM SUBMISSION =====
  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    message.textContent = "";
    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;

    try {
      const payload = {
        postId: Number(postId),
        userId: Number(userId),
        userDescription: document.getElementById("userDescription").value,
        status: "SUBMITTED",
        createdAt: new Date().toISOString()
      };

      const res = await authFetch("/JobApplication/insertApplication", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        if (res.status === 409) throw new Error("You have already applied to this job.");
        throw new Error("Failed to create application.");
      }

      const created = await res.json();
      message.style.color = "green";
      message.textContent = `Application submitted successfully! (ID: ${created.applicationId || created.id})`;
      submitBtn.disabled = true;
      document.getElementById("userDescription").disabled = true;

      setTimeout(() => window.location.href = "/displayJobApplication.html", 500);

    } catch (err) {
      console.error(err);
      message.style.color = "red";
      message.textContent = err.message || "Error submitting application.";
      submitBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
